---
layout: post
title: Android资源管理框架
description: Android资源管理框架
category: blog
---


### 概述
Android应用程序采用代码逻辑和界面资源分离的方式，在程序运行的时候，程序根据屏幕的分辨率，以及系统属性动态加载布局资源。

Android应用程序资源分为两大类，分别是assets和res：

**assets:** assets类资源放在工程根目录的assets子目录下，它里面保存的是一些原始的文件，可以以任何方式来进行组织。这些文件最终会被**原装不动地**打包在apk文件中。如果我们要在程序中访问这些文件，那么就需要指定文件名来访问。

```java
	AssetManager am= getAssets();
	InputStream is = assset.open("filename");
```
**res:** res类资源放在工程根目录的res子目录下，它里面保存的文件大多数都会被编译，并且都会被赋予资源ID。这样可以在程序中通过ID来访问res类的资源。res类资源按照不同的用途可以进一步划分为以下9种子类型：

| 类型 | 用途 |
| ---  | ---  |
| animator | 这类资源以XML文件保存在res/animator目录下，用来描述属性动画。属性动画通过改变对象的属性来实现动画效果。例如，通过不断地修改对象的坐标值来实现对象移动动画，又如，通过不断地修改对象的Alpha通道值来实现对象的渐变效果。 |
| anim | 这类资源以XML文件保存在res/anim目录下，用来描述补间动画。补间动画和属性动画不同，它不是通过修改对象的属性来实现，而是在对象的原来形状或者位置的基础上实现一个变换来得到的，例如，对对象施加一个旋转变换，就可以获得一个旋转动画，从数学上来讲，就是在对象的原来形状或者位置的基础上施加一个变换矩阵来实现动画效果。注意，在动画的执行过程中，对象的属性是始终保持不变的，我们看到的只不过是它的一个变形副本。 |
| color | 用来描述在不同状态下是颜色值 |
| drawable | 这类资源以XML或者Bitmap文件保存在res/drawable目录下，用来描述可绘制对象。注意，保存在这个目录中的Bitmap文件在打包的过程中，可能会被优化的。例如，一个不需要多于256色的真彩色PNG文件可能会被转换成一个只有8位调色板的PNG面板，这样就可以无损地压缩图片，以减少图片所占用的内存资源。|
| layout | 用来描述应用程序界面布局 |
| menu | 用来描述应用程序菜单 |
| raw | 这类资源以任意格式的文件保存在res/raw目录下，它们和assets类资源一样，都是原装不动地打包在apk文件中的，不过它们会被赋予资源ID，这样我们就可以在程序中通过ID来访问它们。|
| values | 用来描述一些简单值，例如，数组、颜色、尺寸、字符串和样式值等，一般来说，这六种不同的值分别保存在名称为arrays.xml、colors.xml、dimens.xml、strings.xml和styles.xml文件中。|
| xml | 一般就是用来描述应用程序的配置信息 |

这9种资源文件，除了raw、Bitmap文件的drawable类型的外，其他的均为xml文本格式的。在打包的时候，会被编译成**二进制格式的xml文件**。这些二进制格式的XML文件分别有一个字符串资源池，用来保存文件中引用到的每一个字符串，包括XML元素标签、属性名称、属性值，以及其它的一切文本值所使用到的字符串。这样原来在文本格式的XML文件中的每一个放置字符串的地方在二进制格式的XML文件中都被替换成一个索引到字符串资源池的整数值。这样做有两个好处：

1. 文件占用更小。例如，假设在原来的文本格式的XML文件中，有四个地方使用的都是同一个字符串，那么在最终编译出来的二进制格式的XML文件中，字符串资源池只有一份字符串值，而引用它的四个地方只占用一个整数值。
2. 解析速度更快。由于在二进制格式的XML文件中，所有的XML元素标签和属性等值都是使用整数来描述的，因此，在解析的过程中，就不再需要进行字符串解析，这样就可以提高解析速度。 

还有另外一个地方需要注意的是，每一个res资源在编译的打包完成之后，都会被分配一个资源ID，这些资源ID被终会被定义为Java常量值，保存在一个R.java文件中，与应用程序的其它源文件一起被编译到程序中，这样我们就可以在程序或者资源文件中通过这些ID常量来访问指定的资源。

应用程序资源的组织方式有18个维度：

![资源纬度](/images/res_wd.jpg)

表格中的18个维度是按照优先级从最大到小排列的，这个优先级次序可以帮助系统根据机器的本地配置来在应用程序资源目录中找到最合适的资源来使用。

具体来说，Android资源管理框架按照图2所示的算法流程来在应用程序资源目录中选择最合适的资源：

![查找算法](/images/res-selection-flowchart.png)

假设一个应用程序的drawable资源按照以下方式来组织：

```java
drawable/
drawable-en/
drawable-fr-rCA/
drawable-en-port/
drawable-en-notouch-12key/
drawable-port-ldpi/
drawable-port-notouch-12key/
```

并且该应用程序所运行在的设置的配置情况如下所示：
 
```java
Locale = en-GB 
Screen orientation = port 
Screen pixel density = hdpi 
Touchscreen type = notouch 
Primary text input method = 12key
``` 

根据上图所示的算法，Android资源管理框架按照以下步骤来选择一个drawable资源：
 
1. 淘汰与设备配置冲突的资源文件

   drawable-fr-rCA/ 目录与 en-GB 语言区域冲突，因而被淘汰。
      
2. 选择列表（表 2）中（下一个）优先级最高的限定符。（先从 MCC 开始，然后下移。）
3. 是否有资源目录包括此限定符？

	* 若无，请返回到第 2 步，看看下一个限定符。（在该示例中，除非达到语言限定符，否则答案始终为“否”。）
   * 若有，请继续执行第 4 步。

4. 淘汰不含此限定符的资源目录。在该示例中，系统会淘汰所有不含语言限定符的目录。
5. 返回并重复第 2 步、第 3 步和第 4 步，直到只剩下一个目录为止。在此示例中，屏幕方向是下一个判断是否匹配的限定符。因此，未指定屏幕方向的资源被淘汰.

剩下的目录是 drawable-en-port。





















































